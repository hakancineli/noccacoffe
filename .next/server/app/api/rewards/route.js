"use strict";(()=>{var e={};e.id=146,e.ids=[146],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},4593:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>k,originalPathname:()=>v,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>w,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>j});var a={};t.r(a),t.d(a,{GET:()=>c,POST:()=>p});var s=t(884),n=t(6132),u=t(1040),i=t(5798),o=t(6721),d=t.n(o),l=t(7542);async function c(e){try{let{searchParams:r}=new URL(e.url),t=r.get("userId");if(t){let r=e.cookies.get("auth-token")?.value;if(!r)return i.Z.json({error:"Oturum bulunamadı"},{status:401});let a=d().verify(r,process.env.JWT_SECRET||"fallback-secret");if(a.userId!==t)return i.Z.json({error:"Yetkisiz erişim"},{status:403});let s=await l._.userReward.findMany({where:{userId:t,status:"AVAILABLE"},include:{reward:!0},orderBy:{createdAt:"desc"}});return i.Z.json({userRewards:s})}{let e=await l._.reward.findMany({where:{isActive:!0},orderBy:{name:"asc"}});return i.Z.json({rewards:e})}}catch(e){return console.error("Get rewards error:",e),i.Z.json({error:"\xd6d\xfcller alınırken bir hata oluştu"},{status:500})}}async function p(e){try{let r=e.cookies.get("auth-token")?.value;if(!r)return i.Z.json({error:"Oturum bulunamadı"},{status:401});let t=d().verify(r,process.env.JWT_SECRET||"fallback-secret"),{rewardId:a}=await e.json();if(!a)return i.Z.json({error:"\xd6d\xfcl ID zorunludur"},{status:400});let s=await l._.reward.findUnique({where:{id:a}});if(!s)return i.Z.json({error:"\xd6d\xfcl bulunamadı"},{status:404});if(!s.isActive)return i.Z.json({error:"Bu \xf6d\xfcl şu anda aktif değil"},{status:400});let n=await l._.userPoints.findUnique({where:{userId:t.userId}});if(!n)return i.Z.json({error:"Kullanıcı puanları bulunamadı"},{status:404});if(n.points<s.pointsCost)return i.Z.json({error:"Yetersiz puan"},{status:400});let u=await l._.userReward.findFirst({where:{userId:t.userId,rewardId:a,status:"AVAILABLE"}});if(u)return i.Z.json({error:"Bu \xf6d\xfcl zaten mevcut"},{status:400});let o=await l._.$transaction(async e=>{let r=await e.userPoints.update({where:{userId:t.userId},data:{points:n.points-s.pointsCost}});await e.pointTransaction.create({data:{userId:t.userId,points:s.pointsCost,transactionType:"REDEEMED",description:`\xd6d\xfcl kullanıldı: ${s.name}`,referenceId:a}});let u=await e.userReward.create({data:{userId:t.userId,rewardId:a,status:"AVAILABLE",expiresAt:new Date(Date.now()+2592e6)},include:{reward:!0}});return{userReward:u,updatedUserPoints:r}});return i.Z.json({message:"\xd6d\xfcl başarıyla kullanıldı",userReward:o.userReward,remainingPoints:o.updatedUserPoints.points})}catch(e){return console.error("Redeem reward error:",e),i.Z.json({error:"\xd6d\xfcl kullanılırken bir hata oluştu"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/rewards/route",pathname:"/api/rewards",filename:"route",bundlePath:"app/api/rewards/route"},resolvedPagePath:"/Users/hakancineli/CascadeProjects/starbucks-turkey-clone/src/app/api/rewards/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:h,headerHooks:k,staticGenerationBailout:j}=w,v="/api/rewards/route";function y(){return(0,u.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},7542:(e,r,t)=>{t.d(r,{_:()=>n});let a=require("@prisma/client"),s=globalThis,n=s.prisma??new a.PrismaClient}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[271,107,721],()=>t(4593));module.exports=a})();